<!doctype html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="shortcut icon" href="/favicon.ico" />
    <title>Logical Astrology</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Bootstrap 5 -->
    <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
            rel="stylesheet"
    />

    <!-- Estilo custom (glassmorphism + tamanhos maiores) -->
    <style>
        :root {
          font-size: 19px;
        }

        body {
          min-height: 100vh;
          margin: 0;
          padding: 0;
          font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
          background: radial-gradient(circle at top, #1b2440, #050816 55%, #02030a 100%);
          color: #f5f5f5;
        }

        .glass-card {
          background: rgba(255, 255, 255, 0.06);
          border-radius: 22px;
          border: 1px solid rgba(255, 255, 255, 0.18);
          box-shadow: 0 22px 45px rgba(0, 0, 0, 0.4);
          backdrop-filter: blur(16px);
          -webkit-backdrop-filter: blur(16px);
        }

        .sign-card {
          cursor: pointer;
          transition: transform 0.15s ease, box-shadow 0.15s ease, border 0.15s ease, background 0.15s ease;
          border-radius: 20px;
          background: rgba(255, 255, 255, 0.07);
          border: 1px solid transparent;
          min-height: 120px;
        }

        .sign-card:hover {
          transform: translateY(-3px);
          box-shadow: 0 14px 28px rgba(0, 0, 0, 0.45);
          border: 1px solid rgba(255, 255, 255, 0.35);
          background: rgba(255, 255, 255, 0.09);
        }

        .sign-icon-big {
          font-size: 2.5rem;
        }

        .sign-name-big {
          font-weight: 600;
          letter-spacing: 0.04em;
          font-size: 1.05rem;
        }

        .sign-strip {
          display: flex;
          gap: 0.4rem;
          overflow-x: auto;
        }

        .sign-strip-item {
          min-width: 3.1rem;
          max-width: 3.1rem;
          height: 3.1rem;
          border-radius: 999px;
          border: 1px solid rgba(255, 255, 255, 0.35);
          background: rgba(255, 255, 255, 0.08);
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-content: center;
          cursor: pointer;
          font-size: 1.3rem;
          transition: transform 0.1s ease, box-shadow 0.1s ease, background 0.1s ease, border 0.1s ease;
          flex-shrink: 0;
        }

        .sign-strip-item span {
          font-size: 0.55rem;
          line-height: 0.7rem;
          margin-top: -2px;
        }

        .sign-strip-item.active {
          background: rgba(56, 189, 248, 0.2);
          border-color: rgba(56, 189, 248, 0.9);
          box-shadow: 0 0 10px rgba(56, 189, 248, 0.7);
          transform: translateY(-1px);
        }

        .coherence-pill {
          display: none;
          align-items: center;
          gap: 0.35rem;
          padding: 0.4rem 0.9rem;
          border-radius: 999px;
          background: rgba(56, 189, 248, 0.1);
          border: 1px solid rgba(56, 189, 248, 0.6);
          font-size: 0.85rem;
          color: #7dd3fc;
          white-space: nowrap;
        }

        .badge-source {
          background: rgba(255, 255, 255, 0.08);
          border: 1px solid rgba(255, 255, 255, 0.25);
          border-radius: 999px;
          font-size: 0.75rem;
          padding: 0.2rem 0.6rem;
        }

        .opacity-70 { opacity: 0.7; }
        .opacity-80 { opacity: 0.8; }

        .view-hidden {
          display: none !important;
        }

        .btn-back {
          border-radius: 999px;
          border-width: 1px;
          font-size: 0.9rem;
          padding: 0.45rem 1.2rem;
        }

        .analysis-text {
          font-size: 23px;
          font-weight: 500;
          line-height: 1.5;
        }

        .prediction-text {
          font-weight: 400;
          line-height: 1.5;
          font-style: oblique;
        }

        #selected-sign-name {
          font-size: 1.7rem;
          font-weight: 700;
        }

        .analysis-title {
          color: cyan;
          font-weight: 700;
        }

        .thematic-result {
          min-height: 80px;
          border-radius: 12px;
          border: 1px solid rgba(255, 255, 255, 0.15);
          background: rgba(15, 23, 42, 0.65);
        }

        .thematic-inner {
          border-radius: 14px;
        }

        .thematic-title {
          font-weight: 700;
        }

        .thematic-result {
          min-height: 80px;
          border-radius: 12px;
          border: 1px solid rgba(255, 255, 255, 0.15);
          background: rgba(15, 23, 42, 0.65);
        }

        .thematic-inner {
          border-radius: 14px;
        }

        .thematic-title {
          font-weight: 700;
        }

        .source-btn {
          font-size: 0.85rem;
          border-radius: 999px;
          padding: 0.3rem 0.9rem;
        }

        .source-btn.active {
          background-color: rgba(56, 189, 248, 0.2);
          border-color: rgba(56, 189, 248, 0.9);
          color: #e0f2fe;
          box-shadow: 0 0 8px rgba(56, 189, 248, 0.6);
        }

        @keyframes fadeSlideIn {
          from {
            opacity: 0;
            transform: translateY(10px);
          }
          to {
            opacity: 1;
            transform: translateY(0);
          }
        }

        .animate-view {
          animation: fadeSlideIn 220ms ease-out;
        }

        /* Logo glassmorphism */
        .logo-link {
          text-decoration: none;
          color: inherit;
          display: inline-flex;
          align-items: center;
          gap: 0.9rem;
          white-space: nowrap;
        }

        .logo-mark {
          width: 35px;
          height: 35px;
          border-radius: 999px;
          background: radial-gradient(circle at 30% 20%, rgba(244, 244, 255, 0.9), rgba(59, 130, 246, 0.35) 45%, rgba(15, 23, 42, 0.9));
          box-shadow: 0 12px 30px rgba(0, 0, 0, 0.55);
          border: 1px solid rgba(255, 255, 255, 0.45);
          display: flex;
          align-items: center;
          justify-content: center;
          backdrop-filter: blur(12px);
          -webkit-backdrop-filter: blur(12px);
          font-size: 1.4rem;
        }

        .logo-symbol {
          transform: translateY(-1px);
        }

        .logo-text {
          text-transform: uppercase;
          letter-spacing: 0.14em;
          font-weight: 700;
          font-size: 1.6rem;
        }

        .logo-link:hover .logo-text {
          text-shadow: 0 0 14px rgba(59, 130, 246, 0.8);
        }

        .logo-link:hover .logo-mark {
          box-shadow: 0 16px 36px rgba(37, 99, 235, 0.5);
          transform: translateY(-1px);
        }

        .sign-header-single {
          display: flex;
          justify-content: center;
        }

        /* base do √≠cone */
        .sign-header-item {
          width: 100px;
          height: 100px;
          border-radius: 999px;
          border: 1px solid rgba(255, 255, 255, 0.25);
          background: rgba(15, 23, 42, 0.8);
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 2rem;
          opacity: 0.9;
        }

        /* visual do ‚Äúativo‚Äù (igual ao antigo active) */
        .sign-header-item.active {
          border-color: rgba(56, 189, 248, 0.9);
          background: radial-gradient(
            circle at 30% 20%,
            rgba(248, 250, 252, 0.98),
            rgba(56, 189, 248, 0.5) 40%,
            rgba(15, 23, 42, 1)
          );
          box-shadow: 0 0 18px rgba(56, 189, 248, 0.85);
        }

        .capture-btn {
          background: none;
          border: none;
          outline: none;

          font-size: 1.9rem;           /* tamanho agrad√°vel e vis√≠vel */
          color: #f8fafc;              /* mesmo tom claro usado no conte√∫do */
          cursor: pointer;

          padding: 0.25rem;
          line-height: 1;

          transition:
            transform 0.15s ease,
            opacity 0.15s ease,
            filter 0.15s ease;
        }

        /* leve "flutua√ß√£o" no hover */
        .capture-btn:hover {
          transform: scale(1.15) translateY(-2px);
          filter: drop-shadow(0 0 6px rgba(56, 189, 248, 0.55));
        }

        /* toque no mobile */
        .capture-btn:active {
          transform: scale(0.9);
          filter: drop-shadow(0 0 10px rgba(56, 189, 248, 0.9));
        }

        .capture-btn:focus {
          outline: none;
          box-shadow: none;
        }


        /* T√≠tulo da √°rea de temas - "Descubra seu FUTURO!" */
        .hero-themes-title {
          font-size: 1.5rem;
          font-weight: 800;
          letter-spacing: 0.16em;
          text-transform: uppercase;
          color: #e5e7ff;
          text-shadow: 0 0 10px rgba(56, 189, 248, 0.4);
        }

        .hero-themes-title span {
          color: #38bdf8;
        }

        /* Temas menores na tela inicial */
        #themes-grid .sign-card {
          min-height: 90px;
          padding: 0.6rem 0.4rem;
          box-shadow: 0 14px 28px rgba(0, 0, 0, 0.4);
        }

        #themes-grid .sign-icon-big {
          font-size: 1.9rem;
        }

        #themes-grid .sign-name-big {
          font-size: 0.85rem;
        }

        /* Modo captura: esconde elementos de orienta√ß√£o/inputs/bot√µes */
        .capture-mode .hide-on-capture {
          display: none !important;
        }

        @media (min-width: 768px) {
          :root {
            font-size: 20px;
          }
          .sign-card {
            min-height: 130px;
          }
          .sign-icon-big {
            font-size: 3.1rem;
          }
          #selected-sign-name {
            font-size: 2rem;
          }
          .logo-text {
            font-size: 1.4rem;
          }
        }
        @media (max-width: 480px) {
            .logo-mark {
              width: 35px;
              height: 35px;
              font-size: 2rem;
            }

            .sign-name-big {
              font-size: 0.9rem;
            }

            .logo-text {
              font-size: 1.3rem;
              letter-spacing: 0.13em;
            }
       }
    </style>
</head>
<body>
<div class="container py-4 py-md-5">

    <!-- HEADER com logo clic√°vel -->
    <header class="mb-3 mb-md-4 text-center hide-on-capture">
        <h1 class="h3 mb-1">
            <a href="/" id="logo-link" class="logo-link">
              <span class="logo-mark">
                <span class="logo-symbol">‚ú¶</span>
              </span>
                <span class="logo-text">Logical Astrology</span>
            </a>
        </h1>
        <p id="header-subtitle" class="mb-3 opacity-70">
            Astrologia fazendo sentido. Uma an√°lise l√≥gica e inteligente das principais fontes de hor√≥scopos.
        </p>
    </header>

    <!-- GRID DE TEMAS (AMOR, TRABALHO, FAM√çLIA, AMIGOS) -->
    <section id="themes-grid-view" class="mb-3 mb-md-4">
        <div class="glass-card p-4 p-md-5">
            <h2 class="hero-themes-title mb-3 text-center">
                Descubra seu <span>FUTURO!</span>
            </h2>
            <p class="mb-3 text-center opacity-70">
                Escolha para receber uma previs√£o exclusiva, planeje seus pr√≥ximos passos.
            </p>
            <div class="row g-3 g-md-4" id="themes-grid">
                <!-- preenchido via JS -->
            </div>
        </div>
    </section>

    <!-- VIEW DETALHE DO TEMA (FORM + RESULTADO) -->
    <section id="theme-detail-view" class="mb-3 mb-md-4 view-hidden">
        <div id="theme-card" class="glass-card p-4 p-md-4 d-flex flex-column gap-3">
            <!-- Bot√£o de c√¢mera (print) -->
            <div class="d-flex justify-content-end mb-2 hide-on-capture">
                <button type="button" id="theme-capture-btn" class="capture-btn hide-on-capture">
                    üì∏
                </button>
            </div>

            <div class="text-center mb-2">
                <div id="theme-icon" style="font-size: 2.3rem;">‚ù§Ô∏è</div>
                <h2 id="theme-title" class="h5 mt-2 mb-1 thematic-title"></h2>
                <p id="theme-subtitle" class="small mb-0 opacity-70 hide-on-capture">
                    Preencha os campos e receba uma mensagem √∫nica para o seu momento.
                </p>
            </div>

            <form id="theme-form" class="row g-2 g-md-3 mb-2 hide-on-capture">
                <div class="col-12 col-md-4">
                    <label class="form-label small mb-1">Seu nome</label>
                    <input type="text" id="user-name" class="form-control form-control-sm" placeholder="Digite seu nome" required />
                </div>
                <div class="col-12 col-md-4" id="love-name-wrapper" style="display: none;">
                    <label class="form-label small mb-1">Nome do amor</label>
                    <input type="text" id="love-name" class="form-control form-control-sm" placeholder="Para tema amor" />
                </div>
                <div class="col-12 col-md-4">
                    <label class="form-label small mb-1">Sentimento atual</label>
                    <select id="sentiment" class="form-select form-select-sm">
                        <option value="POSITIVO">Positivo</option>
                        <option value="NEGATIVO">Negativo</option>
                    </select>
                </div>
                <div class="col-12 d-flex justify-content-end">
                    <button type="submit" id="theme-submit-btn" class="btn btn-info btn-sm">Gerar previs√£o</button>
                </div>
            </form>

            <div id="payment-alert" class="small mb-2 opacity-80 hide-on-capture"></div>
            <div id="thematic-result" class="thematic-result p-3"></div>

            <div class="d-flex justify-content-center align-items-center mb-2 hide-on-capture">
                <button type="button" id="theme-back-button" class="btn btn-outline-light btn-sm btn-back">
                    ‚Üê Voltar ao in√≠cio
                </button>
            </div>
        </div>
    </section>

    <!-- VIEW 1: SELE√á√ÉO DE SIGNOS -->
    <section id="signs-view" class="mb-3 mb-md-4">
        <div class="glass-card p-4 p-md-5">
            <h2 class="h5 text-uppercase opacity-80 mb-4 text-center">Escolha um signo</h2>
            <div class="row g-3 g-md-4" id="sign-grid-main">
                <!-- preenchido via JS -->
            </div>
        </div>
    </section>

    <!-- VIEW 2: DETALHES / AN√ÅLISE -->
    <section id="details-view" class="view-hidden">
        <!-- Cabe√ßalho do signo -->
        <div class="mb-3 text-center">
            <div class="sign-header-single">
             <div id="selected-sign-icon" class="sign-header-item active">‚ú®</div>
            </div>
            <h2 id="selected-sign-name" class="mt-2 mb-0"></h2>
        </div>

        <!-- Cart√£o principal: an√°lise + previs√µes -->
        <div id="analysis-card" class="glass-card p-3 p-md-4 d-flex flex-column gap-2">
            <!-- An√°lise -->
            <div>
                <div class="d-flex align-items-center justify-content-between mb-1">
                    <h3 class="h6 mb-0 analysis-title">An√°lise l√≥gica do dia</h3>
                    <div class="d-flex align-items-center gap-2">
                        <button type="button" id="sign-capture-btn" class="capture-btn hide-on-capture">
                            üì∏
                        </button>
                        <span id="coherence-chip" class="coherence-pill d-none">
                            <span class="small">Coer√™ncia:</span>
                            <span id="coherence-score">0%</span>
                        </span>
                        <span class="spinner-border spinner-border-sm d-none hide-on-capture" id="ai-spinner" role="status"></span>
                    </div>
                </div>
                <div id="analysis-box" class="analysis-text mt-2">
                    <span class="opacity-70">
                      Aqui aparecer√° o resumo consolidado gerado para o signo selecionado.
                    </span>
                </div>
            </div>

            <!-- O que dizem os principais sites... -->
            <div class="mt-3">
                <div class="d-flex align-items-center justify-content-between mb-2 hide-on-capture">
                    <h3 class="h6 mb-0">O que dizem os principais sites...</h3>
                    <span class="small opacity-70" id="sources-count-label">0 sites</span>
                </div>

                <!-- Bot√µes das fontes -->
                <div id="sources-buttons" class="d-flex flex-wrap gap-2 mb-2 hide-on-capture">
                    <!-- preenchido via JS -->
                </div>

                <!-- Texto da fonte selecionada -->
                <div id="source-text" class="prediction-text hide-on-capture">
                    <span class="opacity-70">
                      Selecione uma das fontes acima para ver o texto.
                    </span>
                </div>
            </div>
        </div>

        <!-- Bot√£o voltar -->
        <div class="mt-3 d-flex justify-content-center hide-on-capture">
            <button type="button" id="back-button" class="btn btn-outline-light btn-sm btn-back">
                ‚Üê Voltar
            </button>
        </div>
    </section>

</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<!-- Mercado Pago -->
<script src="https://sdk.mercadopago.com/js/v2"></script>

<!-- html2canvas para print bonit√£o -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<!-- L√≥gica JS -->
<script>
    const SIGNS = [
      { id: "aries", label: "√Åries", icon: "‚ôà" },
      { id: "touro", label: "Touro", icon: "‚ôâ" },
      { id: "gemeos", label: "G√™meos", icon: "‚ôä" },
      { id: "cancer", label: "C√¢ncer", icon: "‚ôã" },
      { id: "leao", label: "Le√£o", icon: "‚ôå" },
      { id: "virgem", label: "Virgem", icon: "‚ôç" },
      { id: "libra", label: "Libra", icon: "‚ôé" },
      { id: "escorpiao", label: "Escorp", icon: "‚ôè" },
      { id: "sagitario", label: "Sagit√°r", icon: "‚ôê" },
      { id: "capricornio", label: "Capric√≥r", icon: "‚ôë" },
      { id: "aquario", label: "Aqu√°rio", icon: "‚ôí" },
      { id: "peixes", label: "Peixes", icon: "‚ôì" },
    ];

    const THEMES = [
      { id: "AMOR", label: "Amor", icon: "‚ù§Ô∏è" },
      { id: "TRABALHO", label: "Trabalho", icon: "üíº" },
      { id: "FAMILIA", label: "Fam√≠lia", icon: "üë®‚Äçüë©‚Äçüëß" },
      { id: "AMIGOS", label: "Amigos", icon: "ü§ù" },
    ];

    const signsView = document.getElementById("signs-view");
    const detailsView = document.getElementById("details-view");
    const signGridMain = document.getElementById("sign-grid-main");
    const selectedSignIcon = document.getElementById("selected-sign-icon");
    const selectedSignName = document.getElementById("selected-sign-name");
    const analysisBox = document.getElementById("analysis-box");
    const coherenceChip = document.getElementById("coherence-chip");
    const coherenceScore = document.getElementById("coherence-score");
    const sourcesCountLabel = document.getElementById("sources-count-label");
    const sourcesButtons = document.getElementById("sources-buttons");
    const sourceTextEl = document.getElementById("source-text");
    const aiSpinner = document.getElementById("ai-spinner");
    const backButton = document.getElementById("back-button");
    const headerSubtitle = document.getElementById("header-subtitle");
    const logoLink = document.getElementById("logo-link");

    const themesGridView = document.getElementById("themes-grid-view");
    const themeDetailView = document.getElementById("theme-detail-view");
    const themesGrid = document.getElementById("themes-grid");
    const themeBackButton = document.getElementById("theme-back-button");
    const themeIconEl = document.getElementById("theme-icon");
    const themeTitleEl = document.getElementById("theme-title");
    const themeSubtitleEl = document.getElementById("theme-subtitle");

    const themeForm = document.getElementById("theme-form");
    const userNameInput = document.getElementById("user-name");
    const loveNameWrapper = document.getElementById("love-name-wrapper");
    const loveNameInput = document.getElementById("love-name");
    const sentimentSelect = document.getElementById("sentiment");
    const paymentAlert = document.getElementById("payment-alert");
    const thematicResult = document.getElementById("thematic-result");
    const themeSubmitBtn = document.getElementById("theme-submit-btn");

    const themeCard = document.getElementById("theme-card");
    const analysisCard = document.getElementById("analysis-card");
    const themeCaptureBtn = document.getElementById("theme-capture-btn");
    const signCaptureBtn = document.getElementById("sign-capture-btn");

    let selectedTheme = null;
    let activePaymentToken = localStorage.getItem("activePaymentToken");
    let currentPreferenceId = null;
    let pollInterval = null;
    let mpPublicKey = null;
    let mpInstance = null;
    let currentMpKey = null;

    let currentSignId = null;
    let activeSourceIndex = null;

    /* ==== Helpers de view ==== */
    function applyViewAnimation(el) {
      el.classList.remove("animate-view");
      void el.offsetWidth;
      el.classList.add("animate-view");
      setTimeout(() => el.classList.remove("animate-view"), 250);
    }

    function setView(view) {
      if (view === "home") {
        signsView.classList.remove("view-hidden");
        detailsView.classList.add("view-hidden");
        themeDetailView.classList.add("view-hidden");
        themesGridView.classList.remove("view-hidden");
        headerSubtitle.style.display = "block";
        applyViewAnimation(signsView);
      } else if (view === "sign") {
        detailsView.classList.remove("view-hidden");
        signsView.classList.add("view-hidden");
        themesGridView.classList.add("view-hidden");
        themeDetailView.classList.add("view-hidden");
        headerSubtitle.style.display = "none";
        applyViewAnimation(detailsView);
      }
    }

    function openThemeView(themeId) {
      selectedTheme = themeId;
      const theme = THEMES.find(t => t.id === themeId);
      if (!theme) return;

      themeIconEl.textContent = theme.icon;
      themeTitleEl.textContent = `Previs√£o sobre ${theme.label}`;
      loveNameWrapper.style.display = themeId === "AMOR" ? "block" : "none";

      const cached = getCachedThemePrediction(themeId);
      if (cached) {
        userNameInput.value = cached.userName || "";
        themeSubmitBtn.disabled = true;
        themeForm.classList.add("view-hidden");
        setPaymentMessage(`Voc√™ j√° possui uma previs√£o ativa at√© ${formatarData(cached.expiresAt)}.`, "success");
        renderThematicResult({
          themeId,
          userName: cached.userName,
          message: cached.mensagem,
          expiresAt: cached.expiresAt
        });
      } else {
        themeSubmitBtn.disabled = false;
        themeForm.classList.remove("view-hidden");
        setPaymentMessage("Preencha seus dados para gerar uma previs√£o personalizada.", "info");
        renderThematicResult(null);
      }

      themesGridView.classList.add("view-hidden");
      signsView.classList.add("view-hidden");
      detailsView.classList.add("view-hidden");
      themeDetailView.classList.remove("view-hidden");
      applyViewAnimation(themeDetailView);
    }

    function navigateHome(push = true) {
      currentSignId = null;
      if (push) {
        history.pushState({ view: "home" }, "", "/");
      }
      setView("home");
    }

    /* ==== THEME CACHE HELPERS ==== */
    function isExpired(expiresAt) {
      if (!expiresAt) return true;
      const now = new Date();
      const exp = new Date(expiresAt);
      return now > exp;
    }

    function getCachedThemePrediction(themeId) {
      const raw = localStorage.getItem(`themePrediction_${themeId}`);
      if (!raw) return null;
      try {
        const obj = JSON.parse(raw);
        if (isExpired(obj.expiresAt)) {
          localStorage.removeItem(`themePrediction_${themeId}`);
          return null;
        }
        return obj;
      } catch {
        return null;
      }
    }

    function cacheThemePrediction({ themeId, userName, message, expiresAt }) {
      if (!themeId) return;
      const obj = { themeId, userName, mensagem: message, expiresAt };
      localStorage.setItem(`themePrediction_${themeId}`, JSON.stringify(obj));
    }

    function clearThemePrediction(themeId) {
      if (!themeId) return;
      localStorage.removeItem(`themePrediction_${themeId}`);
    }

    function storePreferenceMeta(prefId, meta) {
      if (!prefId) return;
      localStorage.setItem(`prefMeta_${prefId}`, JSON.stringify(meta));
    }

    function getPreferenceMeta(prefId) {
      const raw = localStorage.getItem(`prefMeta_${prefId}`);
      if (!raw) return null;
      try {
        return JSON.parse(raw);
      } catch {
        return null;
      }
    }

    function updateThemeStatusFromCache() {
      THEMES.forEach(theme => {
        const el = document.getElementById(`theme-status-${theme.id}`);
        if (!el) return;
        const cached = getCachedThemePrediction(theme.id);
        if (cached) {
          el.textContent = `Ativo at√© ${formatarData(cached.expiresAt)}`;
          el.classList.add("opacity-80");
        } else {
          el.textContent = "";
          el.classList.remove("opacity-80");
        }
      });
    }

    /* ==== Mensagens / resultado tem√°tico ==== */
    function setPaymentMessage(message, type = "info") {
      const className = type === "success" ? "text-success" : type === "warning" ? "text-warning" : "text-info";
      paymentAlert.className = `small mb-2 ${className} hide-on-capture`;
      paymentAlert.textContent = message || "";
    }

    function renderThematicResult(content) {
      if (!content) {
        thematicResult.innerHTML =
          "<span class='opacity-70'>O resultado aparecer√° aqui ap√≥s a confirma√ß√£o do pagamento.</span>";
        return;
      }

      if (typeof content === "string") {
        thematicResult.innerHTML = `<span class='opacity-70'>${escapeHtml(content)}</span>`;
        return;
      }

      const theme = THEMES.find(t => t.id === content.themeId) || { label: "seu tema" };
      const userName = content.userName || "Voc√™";
      const safeMessage = escapeHtml(String(content.message || "")).replace(/\n/g, "<br>");

      thematicResult.innerHTML = `
        <div class="thematic-inner">
          <div class="prediction-text">${safeMessage}</div>
        </div>
      `;
    }

    async function startThematicPrediction(event) {
      event.preventDefault();
      if (!selectedTheme) {
        setPaymentMessage("Escolha um tema para continuar.", "warning");
        return;
      }

      const cached = getCachedThemePrediction(selectedTheme);
      if (cached) {
        setPaymentMessage(
          `Voc√™ j√° possui uma previs√£o ativa para este tema at√© ${formatarData(cached.expiresAt)}.`,
          "warning"
        );
        renderThematicResult({
          themeId: selectedTheme,
          userName: cached.userName,
          message: cached.mensagem,
          expiresAt: cached.expiresAt
        });
        themeSubmitBtn.disabled = true;
        themeForm.classList.add("view-hidden");
        return;
      }

      const nome = userNameInput.value.trim();
      const nomeAmor = loveNameInput.value.trim();
      if (!nome) {
        setPaymentMessage("Informe seu nome para gerar a previs√£o.", "warning");
        return;
      }
      setPaymentMessage("Criando pagamento e alinhando sua leitura astrol√≥gica...", "info");
      renderThematicResult("");

      const payload = {
        tema: selectedTheme,
        nome,
        nomeAmor: selectedTheme === "AMOR" ? nomeAmor : undefined,
        sentimento: sentimentSelect.value,
        activePaymentToken: activePaymentToken || undefined,
      };

      try {
        const resp = await fetch("/api/previsoes/tematicas", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        if (!resp.ok) {
          throw new Error("N√£o foi poss√≠vel iniciar a previs√£o tem√°tica.");
        }
        const data = await resp.json();
        currentPreferenceId = data.preferenceId;
        mpPublicKey = data.publicKey;
        storePreferenceMeta(currentPreferenceId, { themeId: selectedTheme, userName: nome });

        const valor = data.valorFinal || data.valorBase;
        const descontoTxt = data.discountApplied ? "(30% de desconto ativo)" : "";
        setPaymentMessage(
          `Pagamento criado. Valor: R$ ${valor} ${descontoTxt}. Confirme no checkout para liberar sua mensagem personalizada.`,
          "info"
        );
        iniciarCheckout(data.preferenceId);
        iniciarPollingStatus(data.preferenceId);
      } catch (error) {
        console.error(error);
        setPaymentMessage(error.message || "Erro ao iniciar a previs√£o.", "warning");
      }
    }

    function iniciarCheckout(preferenceId) {
      if (!mpPublicKey || typeof MercadoPago === "undefined") {
        setPaymentMessage("SDK do Mercado Pago n√£o carregado.", "warning");
        return;
      }
      if (!mpInstance || currentMpKey !== mpPublicKey) {
        mpInstance = new MercadoPago(mpPublicKey, { locale: "pt-BR" });
        currentMpKey = mpPublicKey;
      }
      mpInstance.checkout({
        preference: { id: preferenceId },
        autoOpen: true,
      });
    }

    function iniciarPollingStatus(preferenceId) {
      if (pollInterval) {
        clearInterval(pollInterval);
      }
      verificarStatus(preferenceId);
      pollInterval = setInterval(() => verificarStatus(preferenceId), 4000);
    }

    async function verificarStatus(preferenceId) {
      try {
        const resp = await fetch(`/api/previsoes/tematicas/${preferenceId}`);
        if (!resp.ok) {
          throw new Error("N√£o foi poss√≠vel verificar o status do pagamento.");
        }
        const data = await resp.json();
        if (data.status === "PAID") {
          if (pollInterval) clearInterval(pollInterval);
          activePaymentToken = preferenceId;
          localStorage.setItem("activePaymentToken", preferenceId);

          const meta = getPreferenceMeta(preferenceId) || {};
          const themeId = meta.themeId || selectedTheme;
          const userName = meta.userName || userNameInput.value.trim() || "Voc√™";

          cacheThemePrediction({
            themeId,
            userName,
            message: data.mensagem || "Mensagem gerada.",
            expiresAt: data.expiresAt
          });

          setPaymentMessage(`Pagamento aprovado! Sua previs√£o ficar√° dispon√≠vel at√© ${formatarData(data.expiresAt)}.`, "success");
          renderThematicResult({
            themeId,
            userName,
            message: data.mensagem || "Mensagem gerada.",
            expiresAt: data.expiresAt
          });

          themeSubmitBtn.disabled = true;
          themeForm.classList.add("view-hidden");
          updateThemeStatusFromCache();
        } else if (data.status === "EXPIRED") {
          if (pollInterval) clearInterval(pollInterval);
          if (activePaymentToken === preferenceId) {
            localStorage.removeItem("activePaymentToken");
            activePaymentToken = null;
          }
          const meta = getPreferenceMeta(preferenceId);
          if (meta && meta.themeId) {
            clearThemePrediction(meta.themeId);
          }
          setPaymentMessage("Token expirado. Solicite uma nova previs√£o para continuar.", "warning");
          renderThematicResult("");
          themeSubmitBtn.disabled = false;
          themeForm.classList.remove("view-hidden");
          updateThemeStatusFromCache();
        } else {
          renderThematicResult("Aguardando confirma√ß√£o do pagamento...");
        }
      } catch (err) {
        console.error(err);
        setPaymentMessage(err.message || "Erro ao consultar status.", "warning");
      }
    }

    function formatarData(dateStr) {
      if (!dateStr) return "";
      const d = new Date(dateStr);
      return d.toLocaleString("pt-BR", { dateStyle: "short", timeStyle: "short" });
    }

    function escapeHtml(unsafe) {
      return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    /* ==== GRID DE SIGNOS ==== */
    function renderMainSignGrid() {
      SIGNS.forEach(sign => {
        const col = document.createElement("div");
        col.className = "col-4 col-md-3";

        const card = document.createElement("div");
        card.className = "sign-card p-3 text-center h-100";
        card.onclick = () => navigateToSign(sign.id);

        const icon = document.createElement("div");
        icon.className = "sign-icon-big mb-2";
        icon.textContent = sign.icon;

        const label = document.createElement("div");
        label.className = "sign-name-big";
        label.textContent = sign.label;

        card.appendChild(icon);
        card.appendChild(label);
        col.appendChild(card);
        signGridMain.appendChild(col);
      });
    }

    /* ==== HOR√ìSCOPOS (j√° existentes) ==== */
    function renderSourceButtonsAndText(lista) {
      sourcesButtons.innerHTML = "";
      activeSourceIndex = null;

      if (!Array.isArray(lista) || lista.length === 0) {
        sourcesCountLabel.textContent = "0 sites";
        sourceTextEl.innerHTML = "<span class='opacity-70'>N√£o h√° previs√µes registradas para este signo ainda.</span>";
        return;
      }

      sourcesCountLabel.textContent = `${lista.length} site(s)`;
      sourceTextEl.innerHTML = "<span class='opacity-70'>Selecione uma das fontes acima para ver o texto.</span>";

      lista.forEach((item, index) => {
        const fonteNome = item.source || item.fonte || "Fonte desconhecida";
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "btn btn-outline-light btn-sm source-btn";
        btn.textContent = fonteNome;
        btn.dataset.index = index.toString();

        btn.addEventListener("click", () => {
          const idx = Number(btn.dataset.index);
          if (activeSourceIndex === idx) {
            activeSourceIndex = null;
            setActiveSourceButton(null);
            sourceTextEl.innerHTML = "<span class='opacity-70'>Selecione uma das fontes acima para ver o texto.</span>";
          } else {
            activeSourceIndex = idx;
            setActiveSourceButton(idx);
            renderSourceText(lista[idx]);
          }
        });

        sourcesButtons.appendChild(btn);
      });
    }

    function setActiveSourceButton(activeIdx) {
      const allButtons = sourcesButtons.querySelectorAll(".source-btn");
      allButtons.forEach((btn, idx) => {
        if (activeIdx === null) {
          btn.classList.remove("active");
        } else if (idx === activeIdx) {
          btn.classList.add("active");
        } else {
          btn.classList.remove("active");
        }
      });
    }

    function renderSourceText(item) {
      if (!item) {
        sourceTextEl.innerHTML = "<span class='opacity-70'>Selecione uma das fontes acima para ver o texto.</span>";
        return;
      }

      const texto = item.text || item.descricao || "";
      const dataStr = item.dataColeta || item.date;
      const fonteNome = item.source || item.fonte || "Fonte desconhecida";

      let metaLinha = "";
      if (dataStr) {
        metaLinha = `<div class="small opacity-70 mb-1">${fonteNome} ‚Ä¢ ${dataStr.toString().substring(0, 10)}</div>`;
      } else {
        metaLinha = `<div class="small opacity-70 mb-1">${fonteNome}</div>`;
      }

      sourceTextEl.innerHTML = `
        ${metaLinha}
        <div class="prediction-text">${texto}</div>
      `;
    }

    async function loadSignData(signId, { pushHistory } = { pushHistory: true }) {
      const sign = SIGNS.find(s => s.id === signId);
      if (!sign) return;

      currentSignId = signId;

      selectedSignIcon.textContent = sign.icon;
      selectedSignName.textContent = sign.label;
      analysisBox.innerHTML = "<span class='opacity-70'>Carregando an√°lise do dia...</span>";
      sourceTextEl.innerHTML = "<span class='opacity-70'>Carregando previs√µes das fontes...</span>";
      sourcesButtons.innerHTML = "";
      coherenceChip.classList.add("d-none");
      aiSpinner.classList.remove("d-none");

      if (pushHistory) {
        history.pushState({ view: "sign", signId }, "", "#" + signId);
      }

      try {
        const [analiseResp, horoscoposResp] = await Promise.all([
          fetch(`/api/analise/${signId}`),
          fetch(`/api/horoscopos/${signId}`)
        ]);

        if (analiseResp.ok) {
          const analise = await analiseResp.json();
          const resumo = analise.summary || analise.resumo || "An√°lise n√£o dispon√≠vel.";
          const score = analise.coherenceScore ?? analise.coerencia ?? null;

          analysisBox.textContent = resumo;

          if (score !== null && !isNaN(score)) {
            const perc = Math.round(Number(score) * 100);
            coherenceScore.textContent = perc + "%";
            coherenceChip.classList.remove("d-none");
          } else {
            coherenceChip.classList.add("d-none");
          }
        } else {
          analysisBox.innerHTML = "<span class='text-warning'>N√£o foi poss√≠vel carregar a an√°lise para este signo.</span>";
          coherenceChip.classList.add("d-none");
        }

        if (horoscoposResp.ok) {
          const lista = await horoscoposResp.json();
          renderSourceButtonsAndText(lista);
        } else {
          sourcesCountLabel.textContent = "0 sites";
          sourcesButtons.innerHTML = "";
          sourceTextEl.innerHTML = "<span class='text-warning'>Erro ao buscar previs√µes deste signo.</span>";
        }

        setView("sign");
      } catch (err) {
        console.error(err);
        analysisBox.innerHTML = "<span class='text-danger'>Erro ao consultar a API de an√°lise.</span>";
        sourcesCountLabel.textContent = "0 sites";
        sourcesButtons.innerHTML = "";
        sourceTextEl.innerHTML = "<span class='text-danger'>Erro ao consultar a API de previs√µes.</span>";
        coherenceChip.classList.add("d-none");
      } finally {
        aiSpinner.classList.add("d-none");
      }
    }

    function navigateToSign(signId) {
      loadSignData(signId, { pushHistory: true });
    }

    /* ==== CAPTURA (print screen bonito) ==== */
    /* ==== CAPTURA (print screen bonito) ==== */
async function captureCard(cardElement, fileName) {
  if (!cardElement || typeof html2canvas === "undefined") return;

  // esconde inputs/bot√µes/etc.
  document.body.classList.add("capture-mode");
  await new Promise((r) => setTimeout(r, 120));

  try {
    const canvas = await html2canvas(cardElement, {
      // mant√©m o glassmorphism (sem fundo branco ‚Äúchapado‚Äù)
      backgroundColor: null,
      useCORS: true,
      // melhora a nitidez em celulares
      scale: window.devicePixelRatio > 1 ? 2 : 1,
    });

    const dataUrl = canvas.toDataURL("image/png");

    // download direto do arquivo
    const link = document.createElement("a");
    link.href = dataUrl;
    link.download = fileName || "logical-astrology.png";
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  } catch (e) {
    console.error("Erro ao capturar card:", e);
  } finally {
    document.body.classList.remove("capture-mode");
  }
}


    /* ==== Navega√ß√£o / eventos globais ==== */
    backButton.addEventListener("click", () => {
      history.back();
    });

    themeForm.addEventListener("submit", startThematicPrediction);

    // Clique no logo ‚Üí volta para o menu principal
    logoLink.addEventListener("click", (e) => {
      e.preventDefault();
      navigateHome(true);
    });

    themeBackButton.addEventListener("click", () => {
      navigateHome(true);
    });

    // Bot√£o voltar do navegador
    window.addEventListener("popstate", (event) => {
      const state = event.state;
      if (!state || state.view === "home") {
        navigateHome(false);
      } else if (state.view === "sign" && state.signId) {
        loadSignData(state.signId, { pushHistory: false });
      }
    });

    /* ==== GRID DE TEMAS ==== */
    function renderThemesGrid() {
      themesGrid.innerHTML = "";
      THEMES.forEach(theme => {
        const col = document.createElement("div");
        col.className = "col-6 col-md-3";

        const card = document.createElement("div");
        card.className = "sign-card p-3 text-center h-100";
        card.onclick = () => openThemeView(theme.id);

        const icon = document.createElement("div");
        icon.className = "sign-icon-big mb-2";
        icon.textContent = theme.icon;

        const label = document.createElement("div");
        label.className = "sign-name-big";
        label.textContent = theme.label;

        const status = document.createElement("div");
        status.className = "mt-1 small";
        status.id = `theme-status-${theme.id}`;

        card.appendChild(icon);
        card.appendChild(label);
        card.appendChild(status);
        col.appendChild(card);
        themesGrid.appendChild(col);
      });
      updateThemeStatusFromCache();
    }

    document.addEventListener("DOMContentLoaded", () => {
      renderThemesGrid();

      if (activePaymentToken) {
        setPaymentMessage("Token de pagamento ativo detectado: voc√™ tem 30% de desconto para novas previs√µes enquanto durar.", "info");
      } else {
        setPaymentMessage("Escolha um tema e gere sua previs√£o personalizada.", "info");
      }

      renderMainSignGrid();

      // handlers dos bot√µes de captura
      if (themeCaptureBtn) {
        themeCaptureBtn.addEventListener("click", () => {
          captureCard(themeCard, `logical-astrology-${selectedTheme || "tema"}.png`);
        });
      }
      if (signCaptureBtn) {
        signCaptureBtn.addEventListener("click", () => {
          captureCard(detailsView, `logical-astrology-${currentSignId || "signo"}.png`);
        });
      }

      // handlers dos bot√µes de captura
      if (themeCaptureBtn) {
        themeCaptureBtn.addEventListener("click", () => {
          captureCard(themeCard, `logical-astrology-${selectedTheme || "tema"}.png`);
        });
      }
      if (signCaptureBtn) {
        signCaptureBtn.addEventListener("click", () => {
          captureCard(detailsView, `logical-astrology-${currentSignId || "signo"}.png`);
        });
      }

      const hash = window.location.hash;
      if (hash && hash.startsWith("#")) {
        const signId = hash.substring(1);
        const signExists = SIGNS.some(s => s.id === signId);
        if (signExists) {
          history.replaceState({ view: "sign", signId }, "", "#" + signId);
          loadSignData(signId, { pushHistory: false });
          return;
        }
      }
      history.replaceState({ view: "home" }, "", "/");
      setView("home");
    });
</script>
</body>
</html>
